# 收益验证计算器（事后验证）需求说明

> 范围：仅覆盖收益验证计算器的单次验证功能；不含策略对比模式。

## 目标
- 实际申购后的单笔策略验盈亏，输入实际获配与卖出情况，输出净收益、收益率、打和价与费用拆解。
- 尽量自动：自动带出发行价、识别档位并预估中签股数，减少手动输入错误。

## 数据来源
- 股票列表：`GET /api/stocks`，展示/搜索 IPO 代码与名称。
  - 自动带出发行价（优先“发行价”，无则“招股定价上限”）。
- 档位详情：`GET /api/tier-details/:stockCode`，返回每档的：
  - `shares_applied`、`approx_alloc_pct`（配发比例）、`valid_applications`、`winners`、`apply_group`。

## 输入与交互
- IPO 选择
  - 支持输入/下拉搜索代码或名称，列表项默认展示“代码 + 名称”；失焦或选中时触发带价与档位拉取。
  - 可清空，清空后重置发行价与档位信息。
- 申购与卖出
  - `申购股数`（必填，用于匹配档位、计算需资金与收益率基数）。
  - `发行价`（自动填，允许手动改）。
  - `中签股数`（自动预估，可手动调整）。
  - `卖出价格`（必填）。
- 费用与融资
  - `申购费`：默认 100 HKD，可调。
  - `卖出费`：默认按卖出收入的 0.13219% 预填，可手动修改为固定金额（打和价仍用内置卖出费率计算）。
  - `中签费`：按中签金额 1% 自动计算（无单独输入）。
  - `是否融资`：开关。开启后输入 `融资倍数`、`融资年化利率 (%)`（默认 3.68%）、`持有天数`。
    - 融资额 = 总需求资金 - 本金；总需求资金 = 申购股数 × 发行价；本金 = 总需求资金 / 融资倍数。
- 重置：清空所有输入与计算结果，关闭融资。

## 自动档位识别
- 有档位数据时，输入 `申购股数` 后：
  - 精确匹配 `shares_applied`（允许 0.01 误差）找到档位。
  - 预估中签股数公式（四舍五入到最接近的整数手数）：`(配发比例 × 有效申购人数 × 申购股数) / 中签人数`。
  - 自动填入中签股数并展示计算公式。

## 计算逻辑（单次验证）
1) 金额
   - `paidAmount = 中签股数 × 发行价`
   - `sellRevenue = 中签股数 × 卖出价格`
2) 毛利润
   - `grossProfit = sellRevenue - paidAmount`
3) 融资成本（仅融资时）
   - `financingAmount = (申购股数 × 发行价) - 本金`，`本金 = (申购股数 × 发行价) / 融资倍数`
   - `financingCost = financingAmount × (年化利率 / 365) × 持有天数`
4) 总费用
   - `winningFee = 中签金额 × 1% = (中签股数 × 发行价) × 1%`
   - `totalFees = 申购费 + 融资成本 + 卖出费 + 中签费`
5) 净收益与收益率
   - `netProfit = grossProfit - totalFees`
   - `returnRate = netProfit / (申购股数 × 发行价) × 100%`（收益率基于本金）
6) 打和价
   - 内置卖出费率 0.13219%：`breakEven = (发行价×中签股数 + 申购费 + 融资成本 + 中签费) / (中签股数 × (1 - 0.0013219))`

## 校验与提示
- 必填校验：申购股数、发行价、中签股数、卖出价格须为正数，否则阻断计算并提示。
- 档位缺失或配发字段缺失时，保持手动输入流程，不再自动预估。
- 金额/比例展示需格式化（千分位、保留 2 位小数）。

## 输出
- 净收益（HKD）、收益率（%）
- 打和价（HKD/股）
- 付出金额、卖出收入、毛利润
- 费用拆解：申购费、融资成本、中签费、卖出费、总费用
- 自动档位提示：组别、配发比例、有效申购人数、中签人数、预估中签股数（如可用）
